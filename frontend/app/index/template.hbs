<TrackingBar data-test-tracking-bar />
<div>
  <div class="grid grid--12of12">
    <div class="grid md:grid-cols-[minmax(0,1fr),auto]">
      <h1 class="block">{{moment-format @model "dddd, DD.MM.YYYY"}}</h1>
      <DateNavigation @current={{this.date}} @onChange={{fn (mut this.date)}} />
    </div>
    <div class="max-sm:hidden flex">
      <WeeklyOverview @expected={{this.expectedWorktime}}>
        {{#each this.weeklyOverviewData.value as |d|}}
          <WeeklyOverviewDay
            @day={{d.day}}
            @active={{d.active}}
            @worktime={{d.worktime}}
            @workday={{d.workday}}
            @absence={{d.absence}}
            @holiday={{d.holiday}}
            @prefix={{d.prefix}}
            @onClick={{fn (mut this.date)}}
            data-test-weekly-overview-day={{moment-format d.day "DD"}}
          />
        {{/each}}
      </WeeklyOverview>
    </div>
    <div class="grid-cell visible-sm">
      <NavTabs
        class="max-md:my-2 md:grid-cols-[repeat(3,minmax(0,auto)),50fr] grid"
      >
        <NavTabs::Item>
          <NavTabs::A @route="index.activities">
            Activity
            <NavTabs::Badge>
              {{humanize-duration this.activitySum true}}
            </NavTabs::Badge>
          </NavTabs::A>
        </NavTabs::Item>
        <NavTabs::Item>
          <NavTabs::A @route="index.attendances">
            Attendance
            <NavTabs::Badge>
              {{humanize-duration this.attendanceSum true}}
            </NavTabs::Badge>
          </NavTabs::A>
        </NavTabs::Item>
        <NavTabs::Item>
          <NavTabs::A @route="index.reports">
            Timesheet
            <NavTabs::Badge>
              {{humanize-duration this.reportSum}}
            </NavTabs::Badge>
          </NavTabs::A>
        </NavTabs::Item>
        {{#if this.absence}}
          <li
            class="md:hidden border first:rounded-t-sm last:rounded-b-sm grid"
          >
            <button
              type="button"
              data-test-edit-absence
              class="btn md:btn-warning bg-warning text-foreground-primary border-none rounded-none"
              {{on "click" (toggle "showEditModal" this)}}
            >
              {{this.absence.absenceType.name}}
            </button>
          </li>
        {{/if}}
        <li class="md:hidden border first:rounded-t-sm rounded-b-sm grid">
          <button
            type="button"
            data-test-add-absence
            class="btn md:btn-default border-none rounded-none"
            disabled={{cannot "access page"}}
            {{on "click" (toggle "showAddModal" this)}}
          >
            Add absence
          </button>
        </li>
        <li class="max-md:hidden w-full flex md:justify-end gap-x-2">
          {{#if this.absence}}
            <NavTabs::Button
              type="button"
              data-test-edit-absence
              class="bg-warning/70 border-warning hover:bg-warning text-foreground-primary"
              {{on "click" (toggle "showEditModal" this)}}
            >
              {{this.absence.absenceType.name}}
            </NavTabs::Button>
          {{/if}}
          <NavTabs::Button
            class="hover:text-primary hover:border-primary"
            data-test-add-absence
            disabled={{cannot "access page"}}
            {{on "click" (toggle "showAddModal" this)}}
          >
            Add absence
          </NavTabs::Button>
        </li>
      </NavTabs>
    </div>
    <div class="grid-cell">
      <div class="tab-content">
        {{outlet}}
      </div>
    </div>
  </div>
</div>

{{#if this.absence}}
  {{#let (changeset this.absence this.AbsenceValidations) as |cs|}}
    <SyModal
      @size="auto"
      @visible={{this.showEditModal}}
      @onClose={{queue (toggle "showEditModal" this) (fn this.rollback cs)}}
      as |modal|
    >
      <div data-test-edit-absence-form>
        <ValidatedForm
          @model={{cs}}
          @on-submit={{fn this.saveAbsence cs}}
          as |f|
        >
          <modal.header>
            Edit absence
          </modal.header>
          <modal.body>
            <f.input @name="absenceType" as |fi|>
              <div class="btn-group btn-group--auto">
                {{#each this.absenceTypes as |at|}}
                  <button
                    type="button"
                    class={{concat
                      "btn btn-default"
                      (if (eq at.id cs.absenceType.id) " active")
                    }}
                    {{on "click" (fn fi.update at)}}
                  >{{at.name}}</button>
                {{/each}}
              </div>
            </f.input>
            <f.input @name="date">
              <PowerCalendar
                class="calendar"
                @selected={{cs.date}}
                @center={{or this.center this.date}}
                @onCenterChange={{perform this.setCenter}}
                @onSelect={{pick "moment" (changeset-set cs "date")}}
                as |calendar|
              >
                <div class={{if calendar.loading "loading-mask"}}>
                  <calendar.Nav />
                  <calendar.Days
                    @disabledDates={{this.disabledDatesForEdit}}
                    @startOfWeek={{1}}
                  />
                </div>
              </PowerCalendar>
            </f.input>
            <f.input
              @type="textarea"
              @placeholder="Enter comment..."
              @name="comment"
            />
          </modal.body>
          <modal.footer>
            <button
              type="button"
              class="btn btn-danger"
              {{on "click" (fn this.deleteAbsence this.absence)}}
              data-test-edit-absence-delete
            >Delete</button>
            <f.submit @label="Save" data-test-edit-absence-save />
          </modal.footer>
        </ValidatedForm>
      </div>
    </SyModal>
  {{/let}}
{{/if}}

{{#let (changeset this.newAbsence this.MultipleAbsenceValidations) as |cs|}}
  <SyModal
    @size="auto"
    @visible={{this.showAddModal}}
    @onClose={{queue (toggle "showAddModal" this) (fn this.rollback cs)}}
    as |modal|
  >
    <div data-test-add-absence-form>
      <ValidatedForm @model={{cs}} @on-submit={{fn this.addAbsence cs}} as |f|>
        <modal.header>
          New absence
        </modal.header>
        <modal.body>
          <f.input @name="absenceType" as |fi|>
            <div class="btn-group btn-group--auto">
              {{#each this.absenceTypes as |at|}}
                <button
                  type="button"
                  class={{concat
                    "btn btn-default"
                    (if (eq at.id cs.absenceType.id) " active")
                  }}
                  {{on "click" (fn fi.update at)}}
                >{{at.name}}</button>
              {{/each}}
            </div>
          </f.input>
          <f.input @name="dates">
            <PowerCalendarMultiple
              class="calendar"
              @selected={{cs.dates}}
              @center={{this.center}}
              @onCenterChange={{perform this.setCenter}}
              @onSelect={{fn this.updateSelection cs "dates"}}
              as |calendar|
            >
              <div class={{if calendar.loading "loading-mask"}}>
                <calendar.Nav />
                <calendar.Days
                  @disabledDates={{this.disabledDates}}
                  @startOfWeek={{1}}
                />
              </div>
            </PowerCalendarMultiple>
          </f.input>
          <f.input
            @type="textarea"
            @placeholder="Enter comment..."
            @name="comment"
          />
        </modal.body>
        <modal.footer>
          <f.submit @label="Save" data-test-add-absence-save />
        </modal.footer>
      </ValidatedForm>
    </div>
  </SyModal>
{{/let}}